language: python
services:
  - docker
env:
  global:
    - KILI_API_ENDPOINT=https://staging.cloud.kili-technology.com/api/label/v2/graphql
    # USER_ID
    - secure: "g4esVmaWw9TKBQDk5T5ec9sYU5Tj/vF4b4SrF7zPOMbydzX03nTYBThvAStLgMhNKnqiUV7krDXLs3Jq7s+X7TcycuQpGLUf9qzcfRL3IspLmYTNHeIEtd5OSJOpQWBJeyDGKe+wg6jh8EFggmhQPj+sUEARvdL2I3ECaMEUI9day7cZZjs9D+fMrTfqUfriizCnT3xDH7HFr7ypejhyO7ys0dLAQZUuR24NkPZMS7Vfz6hYMqeZO0RCj6NjdjoiluO/vq7GHTylvBVDsn0RCi9/8ZTPRjec+Q+CneXLyf6YQoWoKigSIcagHz9fRChpGAcLx+GTN7c4ojij0BCmdDba8qxWAHyUE8B7jZGkf8vXzxYTsuQ73XuE+WqcPhtMZK9YtIPfNtZuOnRy9y7KkcFxdSkLiqJ0RkgEp8qIrFarirdAGLttbT9ONl8s7L5c9dm+JMLFypXYI6y3IBgMQsKpPT6jbSSlzxhAok1y6PH7xFgluyukRqzJZxxxd38u6/VFTfe2kCMBDmrPflQN9eQuhQxQSdFtp31lyAocSVkeh7oPfPxIdGH93GWUmdKgNhWoyvDgU1iz7/AY/+cLM0xNaTah9ap9zBO67smZSXSYlh1WWTW3gwzwAG9dN7A8LREqiv5Bk1Au9SoCQAzBRCLnTH8bswp3soERnmKzjmg="
    # API_KEY
    - secure: "KMsmZFmZ62ETZZkKOWQiuwSd0BB1X7PNcbJ20IYNtjDfVVb/zabha7qZAmYnU+6Rx0Exsin4wTEYRy2HzwiVImSpWi306gSXY8mWvKroW6AECYRR9H7YAtNEP1QVsvgrkLfXGCeE9GYyp+NRvXMIbXQSo9DHoZt1VhL3enfp/i4bGXJi7X7SReYYrFbJsHKF3rTSNai13X1SEgZeg+qQlF+MsbwWkov/Z1Nsg1Tt/WDraS4bV3sTJQ0qMMKvwbC0l0HikVVQmpzZJ0xQTJcy2wIrccr53rgnZv+9K5RmOH8yg1f6njyZDz/jQ48dUl5wCsWmnxHYwSa//mWi8Pj8L3ufF35bW6AxXtuqc00hVNvhup39uAHZALHPCZr8NYzykzRZqORbkJsi8/G2s6XPNQPnELVyrcOeSy68HklBHpiqcqq4AMBMpfNS/qup5n2CtF4Ky+tkd9znrxZq9V0Flb6wEnl6srIIjEjcRcXcHYKpc9LQ4X++oSD2GQpTM5LW2qQA06iVc57B7iXq5rAXo7GrgQ2AAOGG8lQ793X5ojbRypslKD79rfQPx2E+asKBhxledbShvIa02vy4sfhj4BxumrL5p1Cq31Gs/1i7t39ACDyy7tNYPLnVY/8TnFBEXfyjAyGZbU3w1crQ4aZEMb42JNb9R8KxWmjAbd7PVcw="
    # USER_EMAIL
    - secure: "D0ZI1ko2VR9OjZU60dFwcKFhgEqKRGA39tcOv9eBeVY7HIx6xuhiuYG6tpak7No3q8mY0SmLqhghCMsfDkcH+qaOlva+lPaAThdLipOnXVVph6ZOLeynyXIedkfD5U/HgYyAnmBI6Zav5nMCyWnvRsQSTttc1Fge/DThoJUVMA9fGw6y2pqQTs9kJsfZhKi5QHKsUn40zJsBwv5b1Raos62UC5bcxIon3/EUhGv6FNN2TgMfw4C20dFPomI/oXs+nwOTL/fJleHWsjuSNWfWfq67h3f53a07DYfkaMVzjC86lATP4N8/YnkcfgYEu/hlWO4KbtcJHDLrRM/ezErCfGK2ZeuYyUfANpTULYz52Hz3sXtDhVICid29h3UNCOqREDoW78hLXBpWy/cFHiPofb1gZZgJjagEPr7dM/KmWcsNpJCT5ox2BnDnXypvJRILjzPo4BRkR3OVb83rYmtPFnacki7+GCd428KDP6pVUlHFjOeVY9ZAT/tRPuYrOHGHzcy69aKmJsUtQeimCUhshgtfIxTM2s6Bjf2EakINIAZ2SbqUM4Hda6k04wCcqW053a7CQ0DaqQ1N3JCQ0ZPWMqDjBG0u3IntjncSZW7OBq0wnHluBVhjUzfwiNrokyOiWBCY3h+NoLuFFwoAvbOUAAby0YAdQZUAiZcLbXOMFIk="
jobs:
  include:
    # To debug a recipe by running it in a Docker locally as it is run in Travis, launch the following lines:
    #
    # DOCKER_IMAGE=continuumio/anaconda3:2020.02
    # KILI_USER_API_KEY=...
    # KILI_USER_ID=...
    # TRAVIS_BRANCH=...
    #
    # docker pull ${DOCKER_IMAGE}
    #
    # docker run \
    #   --env KILI_API_ENDPOINT=https://staging.cloud.kili-technology.com/api/label/v1/graphql \
    #   --env KILI_USER_API_KEY=${KILI_USER_API_KEY} \
    #   --env KILI_USER_ID=${KILI_USER_ID} \
    #   --env KILI_USER_EMAIL=${KILI_USER_EMAIL} \
    #   --rm \
    #   -p 10000:8888 \
    #   ${DOCKER_IMAGE} /bin/sh -c "cd /root && \
    #     apt-get update && apt-get install -y gcc && \
    #     git clone --branch ${TRAVIS_BRANCH} https://github.com/kili-technology/kili-playground.git && \
    #     pip install ./kili-playground && \
    #     jupyter notebook --allow-root --ip=0.0.0.0 --port=8888"
    #
    # Then start http://localhost:10000/?token=TOKEN_OUTPUTED_IN_CONSOLE
    - &test-recipes
      stage: Test *.ipynb in recipes
      script:
        - docker pull ${DOCKER_IMAGE}
        - |
          docker run \
            --env KILI_API_ENDPOINT=${KILI_API_ENDPOINT} \
            --env KILI_USER_ID=${KILI_USER_ID} \
            --env KILI_USER_API_KEY=${KILI_USER_API_KEY} \
            --env KILI_USER_EMAIL=${KILI_USER_EMAIL} \
            ${DOCKER_IMAGE} /bin/sh -c "cd /root && \
              apt-get update && apt-get install -y gcc && \
              git clone --branch ${TRAVIS_BRANCH} https://github.com/kili-technology/kili-playground.git && \
              pip install ./kili-playground && \
              jupyter nbconvert \
                --to notebook \
                --ExecutePreprocessor.kernel_name=python3 \
                --ExecutePreprocessor.timeout=1000 \
                --execute /root/kili-playground/${NOTEBOOK_PATH}"
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/transfer_learning_with_yolo.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/import_predictions.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/create_project.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/medical_imaging.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/query_methods.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/import_assets.ipynb
    # - <<: *test-recipes
    #   env:
    #     - DOCKER_IMAGE=continuumio/anaconda3:2020.02
    #     - NOTEBOOK_PATH=recipes/frame_dicom_data.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/pixel_level_masks.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/import_text_assets.ipynb
