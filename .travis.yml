language: python
services:
  - docker
env:
  global:
    - KILI_API_ENDPOINT=https://staging.cloud.kili-technology.com/api/label/graphql
    - secure: "F7VOvF5UMcpDiPh8+ZUA5M8oZBUHd801pIYGIc2Gucbc024jrRc7Z3hek5XSxFKlFpNiFGKxDUXtPRgghx0SSKIi0ZRU4ZnGV9GAlYN1lHUdwqsszSVHyNcr6gkk1/fzwmaTv/+N5Yy4wxgccZrGsYi0FamCF+dOsViXp6Xqj+TBYwVsW77IxALuwqoO7rhMAlhEGCxHyqHhV6aoJ64p2vCHB3aAEsyinyY8OjXBXjLGIBUZ13qhPEvWt+IwpMG3qxKQnMDioP33afaCaTh+ildg9UOoW3tfJOXcXHRWljgmPeEKngExvutbJdxoex7EClJ9FWzeljqy/8sGbkNPpIxV2NXMSJjwnXAFV5bEQs3cnumH7S+M8aFCh4QMloVdGaJRHf3/OEZnSeR1abP0ocUY1Ujxo9k+xBFDyModsOy0y437chre0vsJvfkYrWN7aPETDDyeivJfQRFkPGlypr31N8E1+sU+x2qcJ8AF6Hfjd2WJNvCh3953tN3BxdqAZP2YneOCMqblLRLiNs1XKoJbP8giT8IMFP6nliRaZaZ/0vjmOYq/HXqsWS8b6f3l9csZ2agfoyzGJuSWd9yiOgHciaYaMBBk4+mrBDrwoENAXXJ5U5IAgfL+ubg4gnTh92ZE13mLE56vysnpmf6Y+TOOTNvJGClA3ygFYjWyEvY="
    - secure: "NyPSkllxolBKWZuHjcgzy7QCxepsYJu09FnA7FwgI8kV2Vrg4tsMY8inR8hiCGMvS3Xg1sLLJKIta0bwY957yVk8j+kEDg9wL4e9oUhIUlG08DBgAQxbKvbB3w6Bgs7J/o5xJ4WITspWXH8XSafcCJdgxch0lYmrBBjvwV+Lb9P5sksfxtlAAAyQgaHFAb4QUBQCXvTuWnnTlRhTrJeUA+T2yu50lASkluz+J+zXGXkCGKnSYjJQNUYdkQJMJUPY7pr+qVIiZ86DE1FYNwYohAaSZxClPB22HJ5uPbp1z0w9kBv6M55DhheFhNiDS48eHDw/OnuF2om48ZYesKzFz7dxn9AG/vFqGwojTwlSXFLB/NUc0jKYKR+o474NvzUqxvcNKLuywQUASJbN6UxyhUPC6sxmStNw048Fytyt7H+dUyJTmBhfj8cPv1jwEdPvGuUSd64wDDud/lTbvyMnvREjc/laIRzmscIpNrEkgVFBA6Rs6sYiQ5k/GeAvsaHT+fXWvU3MgJlUnOwU5WpmdziooCndRdxh3l55xSSk0Xt3ViOJPngnWu9+c6Fh0L1CxG9ny4Vd72DbywwFj18FsDWX3AgYMigCEh3nsmgTrozxBHDP6aJovD4fo9WsZbwFqR0C+QOA1byi48jBOU6QjLVzMm41gr5RGuNHSf7XsSg="
jobs:
  include:
    # To debug a recipe by running it in a Docker locally as it is run in Travis, launch the following lines:
    #
    # DOCKER_IMAGE=...
    # KILI_USER_EMAIL=...
    # KILI_USER_PASSWORD=...
    # TRAVIS_BRANCH=...
    #
    # docker pull ${DOCKER_IMAGE}
    #
    # docker run \
    #   --env KILI_API_ENDPOINT=https://staging.cloud.kili-technology.com/api/label/graphql \
    #   --env KILI_USER_EMAIL=${KILI_USER_EMAIL} \
    #   --env KILI_USER_PASSWORD=${KILI_USER_PASSWORD} \
    #   --rm \
    #   -p 10000:8888 \
    #   ${DOCKER_IMAGE} /bin/sh -c "cd /root && \
    #     apt-get update && apt-get install -y gcc && \
    #     git clone --branch ${TRAVIS_BRANCH} https://github.com/kili-technology/kili-playground.git && \
    #     pip install ./kili-playground && \
    #     jupyter notebook --allow-root --ip=0.0.0.0 --port=8888"
    #
    # Then start https://localhost:10000/?token=TOKEN_OUTPUTED_IN_CONSOLE
    - &test-recipes
      stage: Test *.ipynb in recipes
      script:
        - docker pull ${DOCKER_IMAGE}
        - |
          docker run \
            --env KILI_API_ENDPOINT=${KILI_API_ENDPOINT} \
            --env KILI_USER_ID=${KILI_USER_ID} \
            --env KILI_USER_API_KEY=${KILI_USER_API_KEY} \
            ${DOCKER_IMAGE} /bin/sh -c "cd /root && \
              apt-get update && apt-get install -y gcc && \
              git clone --branch ${TRAVIS_BRANCH} https://github.com/kili-technology/kili-playground.git && \
              pip install ./kili-playground && \
              jupyter nbconvert \
                --to notebook \
                --ExecutePreprocessor.kernel_name=python3 \
                --ExecutePreprocessor.timeout=500 \
                --execute /root/kili-playground/${NOTEBOOK_PATH}"
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/transfer_learning_with_yolo.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/import_predictions.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/create_project.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/medical_imaging.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/query_methods.ipynb
    - <<: *test-recipes
      env:
        - DOCKER_IMAGE=continuumio/anaconda3:2020.02
        - NOTEBOOK_PATH=recipes/import_assets.ipynb
    # Declare other tests as follow:
    # - <<: *test-recipes
    #   env:
    #     - DOCKER_IMAGE=docker/image
    #     - NOTEBOOK_PATH=recipes/path/to.ipynb
